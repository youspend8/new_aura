<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.bitcamp.aura.review.dao.ReviewMapper">
	<insert id="insert" parameterType="java.util.HashMap">
		<selectKey keyProperty="num" resultType="int" order="BEFORE">
			SELECT REVIEW_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		INSERT 
			ALL
	    INTO REVIEW (
			NUM, TITLE, CONTENTS, STARS, GOODS, BOOKMARK, SHARES, READ_COUNT, ADD_DATE, TYPE, COMMENTS
		)
	    VALUES (
	    	#{num, jdbcType=NUMERIC},
	    	#{title, jdbcType=VARCHAR},
	    	#{contents, jdbcType=VARCHAR},
	    	0,
	    	0,
	    	0,
	    	0,
	    	0,
	    	#{addDate, jdbcType=VARCHAR},
	    	#{type, jdbcType=NUMERIC},
	    	0
	    )
	    INTO PLACE_REVIEW (
	    	NUM, ADDRESS1, TEL, SERVICE_TIME, WAITING_TIME, ADDRESS2, ADDRESS3, DETAIL_ADDR
	    )
	    VALUES (
	    	#{num, jdbcType=NUMERIC},
	    	#{address1, jdbcType=VARCHAR},
	    	#{tel, jdbcType=VARCHAR},
	    	#{serviceTime, jdbcType=VARCHAR},
	    	#{waitingTime, jdbcType=VARCHAR},
	    	#{address2, jdbcType=VARCHAR},
	    	#{address3, jdbcType=VARCHAR},
	    	#{detaileAddr, jdbcType=VARCHAR}
	    )
	    <if test="type == 1">
		    INTO RESTAURANT_REVIEW(
		    	NUM, RESTAURANT_CATEGORY, RESTAURANT_DELIVERY, RESTAURANT_TAKEOUT, RESTAURANT_MENU
		    )
		    VALUES (
		    	#{num, jdbcType=NUMERIC},
		    	#{restaurantCategory, jdbcType=NUMERIC},
		    	#{delivery, jdbcType=NUMERIC},
		    	#{takeOut, jdbcType=NUMERIC},
		    	#{menu, jdbcType=VARCHAR}
		    )
	    </if>
	    <if test="type == 2">
		    INTO HOSPITAL_REVIEW (
		    	NUM, HOSPITAL_CATEGORY, MEDICAL_CATEGORY, SUB_MEDICAL_CATEGORY
		    )
		    VALUES (
		    	#{num, jdbcType=NUMERIC},
		    	#{hospitalCategory, jdbcType=NUMERIC},
		    	#{medicalCategory, jdbcType=NUMERIC},
		    	#{subMedicalCategory, jdbcType=VARCHAR}
		    )
	    </if>
		SELECT
		    *
		FROM
		    DUAL
	</insert>
	
	<update id="updateReview" parameterType="ReviewVO">
		update REVIEW set TITLE=#{title}, CONTENTS=#{contents}, STARS=#{stars}, GOODS=#{goods}, 
		BOOKMARK=${bookmark},SHARES=#{shares}, READ_COUNT=#{readCount}, TYPE=#{type}, COMMENTS=#{comments} where NUM=#{num}
<!-- 			update REVIEW set  GOODS=#{goods},BOOKMARK=${bookmark},SHARES=#{shares}	where NUM=#{num} -->
	</update>
	
	<delete id="delete" parameterType="int">
		
	</delete>
	
	<select id="selectHospitalsByParams" parameterType="SearchParams" resultType="HospitalVo">
		SELECT
		    REVIEW.NUM AS num,
		    REVIEW.TITLE AS title,
		    REVIEW.CONTENTS AS contents,
		    REVIEW.STARS AS stars,
		    REVIEW.GOODS AS goods,
		    REVIEW.BOOKMARK AS bookmark,
		    REVIEW.SHARES AS shares,
		    REVIEW.READ_COUNT AS readCount,
		    REVIEW.ADD_DATE AS addDate,
		    REVIEW.TYPE AS type,
		    PLACE_REVIEW.ADDRESS1 AS address1,
		    PLACE_REVIEW.ADDRESS2 AS address2,
		    PLACE_REVIEW.ADDRESS3 AS address3,
		    PLACE_REVIEW.DETAIL_ADDR AS addr,
		    PLACE_REVIEW.TEL AS tel,
		    PLACE_REVIEW.SERVICE_TIME AS serviceTime,
		    PLACE_REVIEW.WAITING_TIME AS waitingTime,
		    HOSPITAL_REVIEW.NUM AS category,
		    HOSPITAL_REVIEW.HOSPITAL_CATEGORY AS hospitalCategory,
		    HOSPITAL_REVIEW.MEDICAL_CATEGORY AS medicalCategory,
		    HOSPITAL_REVIEW.SUB_MEDICAL_CATEGORY AS subCategory
		FROM 
		    REVIEW
        INNER JOIN 
            PLACE_REVIEW
        ON
            REVIEW.NUM = PLACE_REVIEW.NUM
        INNER JOIN
            HOSPITAL_REVIEW
        ON
            PLACE_REVIEW.NUM = HOSPITAL_REVIEW.NUM
        INNER JOIN 
            HOSPITAL_CATEGORY
        ON
            HOSPITAL_REVIEW.HOSPITAL_CATEGORY = HOSPITAL_CATEGORY.CATEGORY_NUM
        INNER JOIN 
            MEDICAL_CATEGORY
        ON
            HOSPITAL_REVIEW.MEDICAL_CATEGORY = MEDICAL_CATEGORY.CATEGORY_NUM
        WHERE 1 = 1
        <if test="keyword != null">
	        AND
	        	REVIEW.TITLE LIKE '%'||#{keyword, jdbcType=VARCHAR}||'%'
        </if> 
        ORDER BY REVIEW.NUM DESC
	</select>
	
	<select id="selectDigitalsByParams" parameterType="SearchParams" resultType="DigitalVO">
	
	</select>
	
	<select id="selectRestaurantsByParams" parameterType="SearchParams" resultType="RestaurantVO">
		SELECT
			*
		FROM (
			SELECT
				ROWNUM rnum,
				REVIEW.*
			FROM (
				SELECT
				    REVIEW.NUM AS num,
				    REVIEW.TITLE AS title,
				    REVIEW.CONTENTS AS contents,
				    REVIEW.STARS AS stars,
				    REVIEW.GOODS AS goods,
				    REVIEW.BOOKMARK AS bookmark,
				    REVIEW.SHARES AS shares,
				    REVIEW.READ_COUNT AS readCount,
				    REVIEW.ADD_DATE AS addDate,
				    REVIEW.TYPE AS type,
				    PLACE_REVIEW.ADDRESS1 AS address1,
				    PLACE_REVIEW.ADDRESS2 AS address2,
				    PLACE_REVIEW.ADDRESS3 AS address3,
				    PLACE_REVIEW.DETAIL_ADDR AS addr,
				    PLACE_REVIEW.TEL AS tel,
				    PLACE_REVIEW.SERVICE_TIME AS serviceTime,
				    PLACE_REVIEW.WAITING_TIME AS waitingTime,
				    RESTAURANT_REVIEW.RESTAURANT_CATEGORY AS category,
				    RESTAURANT_REVIEW.RESTAURANT_DELIVERY AS delivery,
				    RESTAURANT_REVIEW.RESTAURANT_TAKEOUT AS takeOut,
				    RESTAURANT_REVIEW.RESTAURANT_MENU AS menu
				FROM 
				    REVIEW 
		        INNER JOIN 
		            PLACE_REVIEW
		        ON
		            REVIEW.NUM = PLACE_REVIEW.NUM
		        INNER JOIN
		            RESTAURANT_REVIEW
		        ON
		            PLACE_REVIEW.NUM = RESTAURANT_REVIEW.NUM
		        INNER JOIN 
		            RESTAURANT_CATEGORY
		        ON
		            RESTAURANT_REVIEW.RESTAURANT_CATEGORY = RESTAURANT_CATEGORY.CATEGORY_NUM
		        <if test="keyword != null">
			        AND
			        	REVIEW.TITLE LIKE '%'||#{keyword, jdbcType=VARCHAR}||'%'
		        </if> 
		   		ORDER BY REVIEW.NUM DESC
			) REVIEW
		)
		WHERE 
			1 = 1
			<if test="start == 0">
				AND
					rnum BETWEEN 1 AND 5
			</if>
			<if test="start != 0">
				AND
					rnum BETWEEN #{start} AND #{end}
		    </if>
	</select>
	
	<select id="selectOneForUpdateByNum" parameterType="int" resultType="ReviewVO">
		select 
			NUM as num,
			TITLE as title,
			CONTENTS as contents,
			STARS as stars,
			GOODS as goods, 
			BOOKMARK as bookmark,
			SHARES as shares,
			READ_COUNT as readCount,
			ADD_DATE as addDate,
			TYPE as type,
			COMMENTS as comments 
		FROM
			REVIEW
		WHERE
			NUM = #{num}
	</select>
	
	<select id="selectByNum" resultType="HashMap" parameterType="HashMap">
		SELECT
		    REVIEW.NUM AS num,
		    REVIEW.TITLE AS title,
		    REVIEW.CONTENTS AS contents,
		    REVIEW.STARS AS stars,
		    REVIEW.GOODS AS goods,
		    REVIEW.BOOKMARK AS bookmark,
		    REVIEW.SHARES AS shares,
		    REVIEW.READ_COUNT AS readCount,
		    REVIEW.ADD_DATE AS addDate,
		    REVIEW.TYPE AS type,
			<if test='type == 1'>
			    PLACE_REVIEW.ADDRESS1 AS address1,
			    PLACE_REVIEW.ADDRESS2 AS address2,
			    PLACE_REVIEW.ADDRESS3 AS address3,
			    PLACE_REVIEW.DETAIL_ADDR AS addr,
			    PLACE_REVIEW.TEL AS tel,
			    PLACE_REVIEW.SERVICE_TIME AS serviceTime,
			    PLACE_REVIEW.WAITING_TIME AS waitingTime,
			    RESTAURANT_REVIEW.RESTAURANT_CATEGORY AS category,
			    RESTAURANT_REVIEW.RESTAURANT_DELIVERY AS delivery,
			    RESTAURANT_REVIEW.RESTAURANT_TAKEOUT AS takeOut,
			    RESTAURANT_REVIEW.RESTAURANT_MENU AS menu
			</if>
			<if test='type == 2'>
			    PLACE_REVIEW.ADDRESS1 AS address1,
			    PLACE_REVIEW.ADDRESS2 AS address2,
			    PLACE_REVIEW.ADDRESS3 AS address3,
			    PLACE_REVIEW.DETAIL_ADDR AS addr,
			    PLACE_REVIEW.TEL AS tel,
			    PLACE_REVIEW.SERVICE_TIME AS serviceTime,
			    PLACE_REVIEW.WAITING_TIME AS waitingTime,
			    HOSPITAL_REVIEW.NUM AS category,
			    HOSPITAL_REVIEW.HOSPITAL_CATEGORY AS hospitalCategory,
			    HOSPITAL_REVIEW.MEDICAL_CATEGORY AS medicalCategory,
			    HOSPITAL_REVIEW.SUB_MEDICAL_CATEGORY AS subCategory
			</if>
			<if test='type == 3'>
			    PRODUCTOR_REVIEW.NUM AS num,
			    PRODUCTOR_REVIEW.CATEGORY AS category,
			    PRODUCTOR_REVIEW.PRICE AS price,
			    PRODUCTOR_REVIEW.RELEASE AS release,
			    DIGITAL_REVIEW.NUM AS num,
			    DIGITAL_REVIEW.MODEL AS model,
			    DIGITAL_REVIEW.SUB_CATEGORY1 AS subCategory1,
			    DIGITAL_REVIEW.SUB_CATEGORY2 AS subCategory2,
			    DIGITAL_REVIEW.SUB_CATEGORY3 AS subCategory3
			</if>
		FROM 
		    REVIEW
			<if test='type == 1'>
		        INNER JOIN 
		            PLACE_REVIEW
		        ON
		            REVIEW.NUM = PLACE_REVIEW.NUM
		        INNER JOIN
		            RESTAURANT_REVIEW
		        ON
		            PLACE_REVIEW.NUM = RESTAURANT_REVIEW.NUM
		        INNER JOIN 
		            RESTAURANT_CATEGORY
		        ON
		            RESTAURANT_REVIEW.RESTAURANT_CATEGORY = RESTAURANT_CATEGORY.CATEGORY_NUM
			</if>
			<if test='type == 2'>
		        INNER JOIN 
		            PLACE_REVIEW
		        ON
		            REVIEW.NUM = PLACE_REVIEW.NUM
		        INNER JOIN
		            HOSPITAL_REVIEW
		        ON
		            PLACE_REVIEW.NUM = HOSPITAL_REVIEW.NUM
		        INNER JOIN 
		            HOSPITAL_CATEGORY
		        ON
		            HOSPITAL_REVIEW.HOSPITAL_CATEGORY = HOSPITAL_CATEGORY.CATEGORY_NUM
		        INNER JOIN 
		            MEDICAL_CATEGORY
		        ON
		            HOSPITAL_REVIEW.MEDICAL_CATEGORY = MEDICAL_CATEGORY.CATEGORY_NUM
			</if>
			<if test='type == 3'>
		        INNER JOIN 
		            PRODUCTOR_REVIEW
		        ON
		            REVIEW.NUM = PRODUCTOR_REVIEW.NUM
		        INNER JOIN
		            DIGITAL_REVIEW
		        ON
		            PRODUCTOR_REVIEW.NUM = DIGITAL_REVIEW.NUM
			</if>
		WHERE
		    REVIEW.NUM = #{num}
	</select>
	<select id="selectAll" resultMap="selectAllMap">
		SELECT
		    REVIEW.NUM,
		    REVIEW.TITLE,
		    REVIEW.CONTENTS,
		    REVIEW.STARS,
		    REVIEW.GOODS,
		    REVIEW.BOOKMARK,
		    REVIEW.SHARES,
		    REVIEW.READ_COUNT,
		    REVIEW.ADD_DATE,
		    REVIEW.TYPE
		FROM 
		    REVIEW
		ORDER BY NUM
	</select>
	<resultMap type="ReviewVO" id="selectAllMap">
		<id property="num" column="NUM" />
		<result property="title" column="TITLE" />
		<result property="contents" column="CONTENTS" />
		<result property="stars" column="STARS" />
		<result property="goods" column="GOODS" />
		<result property="bookmark" column="BOOKMARK" />
		<result property="shares" column="SHARES" />
		<result property="readCount" column="READ_COUNT" />
		<result property="addDate" column="ADD_DATE" />
		<result property="type" column="TYPE" />
	</resultMap>
</mapper>